<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economía Familiar</title>
    <style>
        :root { --blue: #0056b3; --green: #28a745; --red: #dc3545; --gray: #6c757d; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #f4f7f6; color: #333; }
        
        .header-blue { 
            background: var(--blue); color: white; padding: 40px 20px; 
            text-align: center; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
        }
        .total-monto { font-size: 3rem; font-weight: bold; margin: 5px 0; }
        .diario-monto { font-size: 1.2rem; background: rgba(255,255,255,0.2); padding: 6px 15px; border-radius: 20px; display: inline-block; }
        .config-btn { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 1.8rem; transition: 0.3s; }

        .container { padding: 20px; max-width: 500px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .input-group { display: flex; flex-direction: column; gap: 12px; }
        input, select, button { padding: 14px; border-radius: 10px; border: 1px solid #ddd; font-size: 1rem; outline: none; }
        button.btn-add { background: var(--green); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        .gasto-item { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #eee;
        }
        .gasto-info { display: flex; flex-direction: column; }
        .gasto-fecha { font-size: 0.75rem; color: #888; }
        .gasto-monto { color: var(--red); font-weight: bold; }
        .edit-icon { cursor: pointer; margin-left: 10px; font-size: 1.1rem; opacity: 0.7; }

        #loading { font-size: 0.9rem; margin-bottom: 10px; display: block; opacity: 0.9; font-weight: 300; }
        .btn-footer { padding: 12px; font-size: 0.9rem; margin-top: 10px; width: 100%; cursor: pointer; border: none; border-radius: 10px; color: white; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header-blue">
        <div class="config-btn" onclick="editarPresupuesto()">⚙️</div>
        <span id="loading">Iniciando conexión...</span>
        <div class="total-monto" id="totalMonto">$0</div>
        <div class="diario-monto" id="diarioMonto">Diario: $0</div>
    </div>

    <div class="container">
        <div class="card">
            <div class="input-group">
                <input type="number" id="montoGasto" placeholder="Monto gastado $">
                <select id="tiendaSelect" onchange="toggleOtros(this)">
                    <option value="Juanka">Juanka</option>
                    <option value="Don Lucio">Don Lucio</option>
                    <option value="Boedo">Boedo</option>
                    <option value="Huevos Belgrano">Huevos Belgrano</option>
                    <option value="Disfruta">Disfruta</option>
                    <option value="Anonima">Anonima</option>
                    <option value="Diarco">Diarco</option>
                    <option value="Pastoriza">Pastoriza</option>
                    <option value="De la costa">De la costa</option>
                    <option value="Otros">Otros (Escribir...)</option>
                </select>
                <input type="text" id="otroTienda" placeholder="¿Qué almacén?" style="display:none;">
                <button class="btn-add" onclick="agregarGasto()">+ REGISTRAR GASTO</button>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0">Últimos Gastos</h3>
            <div id="listaGastos">Cargando historial...</div>
            <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">
            <button class="btn-footer" style="background: var(--gray);" onclick="exportarExcel()">DESCARGAR REPORTE (CSV)</button>
            <button class="btn-footer" style="background: var(--red);" onclick="cerrarMesYReiniciar()">CERRAR MES Y REINICIAR</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://sheetdb.io/api/v1/f3gackja99xb4'; 
        let todosLosGastos = [];

        async function cargarDatos() {
            try {
                document.getElementById('loading').innerText = "Sincronizando con Excel...";
                
                // Cargar Gastos (Hoja1)
                const resG = await fetch(`${API_URL}?sheet=Hoja1`);
                const datosG = await resG.json();
                todosLosGastos = Array.isArray(datosG) ? datosG : [];
                
                // Cargar Presupuesto (Hoja2)
                const resP = await fetch(`${API_URL}?sheet=Hoja2`);
                const presuData = await resP.json();

                if (presuData && presuData.length > 0) {
                    const presuInicial = parseFloat(presuData[0].presupuesto) || 0;
                    
                    const totalGastado = todosLosGastos.reduce((acc, g) => {
                        const valor = parseFloat(String(g.monto).replace(',', '.'));
                        return acc + (isNaN(valor) ? 0 : valor);
                    }, 0);

                    const saldoActual = presuInicial - totalGastado;
                    const hoy = new Date();
                    const ultimoDia = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0).getDate();
                    const diasRestantes = (ultimoDia - hoy.getDate()) + 1;

                    document.getElementById('totalMonto').innerText = `$${saldoActual.toLocaleString('es-AR')}`;
                    document.getElementById('diarioMonto').innerText = `Diario: $${(saldoActual / diasRestantes).toLocaleString('es-AR', {maximumFractionDigits:0})}`;
                    document.getElementById('loading').innerText = "Conectado";
                    
                    renderHistorial(todosLosGastos);
                } else {
                    document.getElementById('loading').innerText = "Error: Configura Hoja2";
                }
            } catch (e) { 
                document.getElementById('loading').innerText = "Error de lectura"; 
            }
        }

        async function agregarGasto() {
            const monto = document.getElementById('montoGasto').value;
            let tienda = document.getElementById('tiendaSelect').value;
            if(tienda === 'Otros') tienda = document.getElementById('otroTienda').value;

            if(!monto || !tienda) return alert("Faltan datos");

            document.getElementById('loading').innerText = "Guardando...";
            await fetch(`${API_URL}?sheet=Hoja1`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ data: [{
                    fecha: new Date().toLocaleDateString('es-AR'),
                    monto: monto,
                    tienda: tienda,
                    mes: new Date().getMonth() + 1
                }]})
            });
            location.reload();
        }

        function renderHistorial(datos) {
            const div = document.getElementById('listaGastos');
            if (datos.length === 0) {
                div.innerHTML = "<p style='color:#888'>No hay movimientos</p>";
                return;
            }
            div.innerHTML = '';
            [...datos].reverse().slice(0, 15).forEach(g => {
                const m = parseFloat(String(g.monto).replace(',', '.')) || 0;
                div.innerHTML += `
                    <div class="gasto-item">
                        <div class="gasto-info">
                            <strong>${g.tienda}</strong>
                            <span class="gasto-fecha">${g.fecha}</span>
                        </div>
                        <div style="display:flex; align-items:center;">
                            <span class="gasto-monto">-$${m.toLocaleString('es-AR')}</span>
                            <span class="edit-icon" onclick="editarGasto('${g.tienda}', '${g.monto}')">✏️</span>
                        </div>
                    </div>`;
            });
        }

        async function editarPresupuesto() {
    const nuevoP = prompt("Nuevo presupuesto mensual (solo números):");
    
    if (nuevoP) {
        document.getElementById('loading').innerText = "Actualizando celda A2...";
        
        // Usamos /0 para decirle a SheetDB: "Editá la primera fila de datos que encuentres"
        // Agregamos ?sheet=Hoja2 para que sepa que es en esa pestaña
        const urlUpdate = `${API_URL}/0?sheet=Hoja2`; 
        
        try {
            const res = await fetch(urlUpdate, {
                method: 'PATCH',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    data: { "presupuesto": nuevoP }
                })
            });

            const resultado = await res.json();

            if (res.ok) {
                alert("¡Presupuesto actualizado en Excel!");
                location.reload();
            } else {
                console.log("Error de API:", resultado);
                alert("Error al guardar. Asegúrate de que A1 diga exactamente: presupuesto");
            }
        } catch (e) {
            console.error("Error de red:", e);
            alert("Error de conexión al intentar escribir.");
        }
    }
}



        async function editarGasto(tiendaOrig, montoOrig) {
            const nuevoM = prompt("Monto nuevo:", montoOrig);
            const nuevaT = prompt("Lugar nuevo:", tiendaOrig);
            if(!nuevoM || !nuevaT) return;

            document.getElementById('loading').innerText = "Editando...";
            await fetch(`${API_URL}/tienda/${tiendaOrig}?sheet=Hoja1`, {
                method: 'PATCH',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ data: { monto: nuevoM, tienda: nuevaT } })
            });
            location.reload();
        }

        function exportarExcel() {
            if(todosLosGastos.length === 0) return alert("No hay datos");
            let csv = "\ufeffFecha,Monto,Tienda,Mes\n";
            todosLosGastos.forEach(g => { csv += `${g.fecha},${g.monto},${g.tienda},${g.mes}\n`; });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Resumen_Gastos.csv`;
            link.click();
        }

        async function cerrarMesYReiniciar() {
            if(confirm("Se bajará el reporte y se borrarán los gastos. ¿Continuar?")) {
                exportarExcel();
                document.getElementById('loading').innerText = "Vaciando...";
                await fetch(`${API_URL}/all?sheet=Hoja1`, { method: 'DELETE' });
                location.reload();
            }
        }

        function toggleOtros(sel) { document.getElementById('otroTienda').style.display = (sel.value === 'Otros') ? 'block' : 'none'; }
        
        cargarDatos();
    </script>
</body>
</html>
